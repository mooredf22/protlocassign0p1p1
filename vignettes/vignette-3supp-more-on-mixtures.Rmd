---
title: 'Vignette 3supp: More on mixtures and transformations'
author: "Dirk Moore"
date: "`r Sys.Date()`"
output:
  #html_document:
  #  toc: yes
  #  df_print: paged
  word_document:
  fig_caption: yes
toc: yes
#pdf_document:
#  toc: yes
vignette: |
  %\VignetteIndexEntry{protlocassign} %\VignetteEngine{knitr::rmarkdown}
---


  ```{r setup, include = FALSE}
knitr::opts_chunk$set(
  #collapse = TRUE,
  comment = "",
  fig.width = 4,
  fig.height = 4,
  message = FALSE,
  warning = FALSE,
  tidy.opts = list(
    keep.blank.line = TRUE,
    width.cutoff = 150
  ),
  options(width = 150),
  eval = TRUE
)
```
In this supplemental vignette we further explore the effect of transformations on CPA estimates. We begin by creating the normalized amounts for the reference proteins, which we will use to create mixtures.

```{r, echo=TRUE, eval=TRUE}
library(protlocassign)
library(pracma)
markerLocR <- cpaSetup(protProfileSummary=protProfileSummaryTMTms2, refLocProteins=refLocProteinsJadot, n.channels=9)
AcupMarkers <- relAmtTransform(markerLocR, NstartMaterialFractions=6, totProt=tmtMS2totProt)
```


Now create markers using AcupMarkers Cyto (row 1) and Lyso (row 4) in the standard way, and transform the mixtures to relative specific amounts

```{r, echo=TRUE, eval=TRUE}
i=1
j=4
mixProtiProtj <- proteinMix(AcupMarkers, Loc1=i, Loc2=j)
mixProtiProtjRSA <- RSAfromAcup(Acup=mixProtiProtj$mixAmount, NstartMaterialFractions=6, totProt=tmtMS2totProt)
```

Next, obtain CPA estimates using the RSA-transformed mixtures and RSA-transformed references profiles. We see that the CPA estimates match the proportions we used to create the mixtures:

```{r, echo=TRUE, eval=TRUE}
markerLocRrsa <- RSAfromS(SS=markerLocR, NstartMaterialFractions=6,
        totProt=tmtMS2totProt)
mixProtiProtjProp <- proLocAll(protProfileSummary=mixProtiProtjRSA, markerLocR=markerLocRrsa,
                             n.channels=9)
round(mixProtiProtjProp, digits=3)
```


Now, instead of transforming the Acup mixtures to RSA's, what happens if we just use the Acup mixtures themselves? The results show significant departures of the CPA estimates from the proportions used to create the mixtures:

```{r, echo=TRUE, eval=TRUE}
mixProtiProtjPropAcup <- proLocAll(protProfileSummary=mixProtiProtj$mixAmount, markerLocR=AcupMarkers,
                                 n.channels=9)
round(mixProtiProtjPropAcup, digits=3)
```

To understand why, here are the AcupMarkers. Note that the three Nyc columns, which are important for classifying lysosomal proteins, are very small, which effectively down-weights their importance in the CPA procedure:

```{r, echo=TRUE, eval=TRUE}
round(AcupMarkers, digits=4)
```

As an allternative to RSA, let us apply log2 transformation of the Acup values. The resulting CPA estimates are much closer to the true values, but not as close as we had obtained using the RSA transformation:

```{r, echo=TRUE, eval=TRUE}
eps <- 0.00005
AcupMarkersLog2 <- log2(AcupMarkers + eps)

mixProtiProtjPropAcupLog2 <- proLocAll(protProfileSummary=log2(mixProtiProtj$mixAmount + eps),
                                       markerLocR=AcupMarkersLog2, n.channels=9)
round(mixProtiProtjPropAcupLog2, digits=3)
```

Following are plots of the CPA estimated vs actual mixture proportions for RSA-transformed values, Acup values, and log2-Acup values.

```{r, echo=TRUE, eval=TRUE, fig.show='hold', fig.width = 7, fig.height = 10}
par(mfrow=c(2,2))
mixturePlot(mixProtiProtjProp=mixProtiProtjProp, NstartMaterialFractions=6, Loc1=i, Loc2=j,
            mix.df=mixProtiProtj$mix.df, errorReturn = T)
mixturePlot(mixProtiProtjProp=mixProtiProtjPropAcup, NstartMaterialFractions=6, Loc1=i, Loc2=j,
            mix.df=mixProtiProtj$mix.df, errorReturn = T)
mixturePlot(mixProtiProtjProp=mixProtiProtjPropAcupLog2, NstartMaterialFractions=6, Loc1=i, Loc2=j,
            mix.df=mixProtiProtj$mix.df, errorReturn = T)
```


Next we create markers using AcupMarkers Cyto and Nuc the standard way. We shall see that here, Acup-transformed values produce good CPA estimates, just as RSA-transformed values. The difference is that, unlike with Lyso, the Nuc (and Cyto) profiles do not depend on the Nyc portions of the values, and thus the estimated subcellular residence proportions do not suffer from the extrememly small Nyc profile values.

Here are the CPA estimates from RSA-transformed profiles:

```{r, echo=TRUE, eval=TRUE}
i=1
j=6
mixProtiProtj <- proteinMix(AcupMarkers, Loc1=i, Loc2=j)
mixProtiProtjRSA <- RSAfromAcup(Acup=mixProtiProtj$mixAmount, NstartMaterialFractions=6, totProt=tmtMS2totProt)


mixProtiProtjProp <- proLocAll(protProfileSummary=mixProtiProtjRSA, markerLocR=markerLocRrsa,
                               n.channels=9)
round(mixProtiProtjProp, digits=3)
```

Now do this using "Acup markers" instead of RSA-transformed values. The CPA estimates are still good here.

```{r, echo=TRUE, eval=TRUE}
mixProtiProtjPropAcup <- proLocAll(protProfileSummary=mixProtiProtj$mixAmount, markerLocR=AcupMarkers,
                                   n.channels=9)
```

Note that these are different:

```{r, echo=TRUE, eval=TRUE}
round(mixProtiProtjPropAcup, digits=3)
```

Now try a log2 transformation of the Acup values. Note that the CPA values are different.

```{r, echo=TRUE, eval=TRUE}
eps <- 0.00005
AcupMarkersLog2 <- log2(AcupMarkers + eps)

mixProtiProtjPropAcupLog2 <- proLocAll(protProfileSummary=log2(mixProtiProtj$mixAmount + eps),
        markerLocR=AcupMarkersLog2, n.channels=9)
round(mixProtiProtjPropAcupLog2, digits=3)
```

Following are plots of the CPA estimated vs actual mixture proportions for RSA-transformed values, Acup values, and log2-Acup values.

```{r, echo=TRUE, eval=TRUE, fig.show='hold', fig.width = 7, fig.height = 10}
par(mfrow=c(2,2))
mixturePlot(mixProtiProtjProp=mixProtiProtjProp, NstartMaterialFractions=6, Loc1=i, Loc2=j,
            mix.df=mixProtiProtj$mix.df, errorReturn = T)
mixturePlot(mixProtiProtjProp=mixProtiProtjPropAcup, NstartMaterialFractions=6, Loc1=i, Loc2=j,
            mix.df=mixProtiProtj$mix.df, errorReturn = T)
mixturePlot(mixProtiProtjProp=mixProtiProtjPropAcupLog2, NstartMaterialFractions=6, Loc1=i, Loc2=j,
            mix.df=mixProtiProtj$mix.df, errorReturn = T)
```
